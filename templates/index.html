<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attendance Sheet</title>
  <style>
    /* Basic calendar style */
    table { width: 100%; border-collapse: collapse; }
    td { border: 1px solid #ccc; width: 14%; height: 100px; vertical-align: top; position: relative; }
    .date { position: absolute; top: 0; right: 0; padding: 2px; font-size: 12px; }
    .checkin { margin: 2px; padding: 2px; border-radius: 3px; cursor: pointer; }
    /* Build Name List button style (top right) */
    #buildNameListButton {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
    }
    /* Modal style */
    .modal {
      display: none;
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 15% auto;
      padding: 20px;
      width: 300px;
      border-radius: 5px;
      text-align: center;
    }
    .modal-buttons { margin-top: 10px; }
    input, select { margin: 5px 0; padding: 5px; width: 80%; }
    ul { list-style: none; padding-left: 0; }
    li {
      padding: 3px 0;
      cursor: pointer;
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      border-radius: 3px;
      margin: 2px 0;
    }
    li:hover {
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
    }
  </style>
  <!-- Include the Socket.IO client library -->
  <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
</head>
<body>
  <h1>Attendance Sheet</h1>
  <!-- Button to build the name list -->
  <button id="buildNameListButton">Build Name List</button>
  
  <table id="calendar">
    <!-- Calendar will be generated dynamically with JavaScript -->
  </table>

  <!-- Modal for building the name list -->
  <div id="nameListModal" class="modal">
    <div class="modal-content">
      <p>Enter a name to add to the list:</p>
      <input id="newNameInput" type="text" placeholder="Name">
      <div class="modal-buttons">
        <button id="addNameButton">Add Name</button>
        <button id="closeNameListModal">Close</button>
      </div>
      <div id="nameListDisplay" style="margin-top:10px; text-align:left;">
        <p>Current Names (click to delete):</p>
        <ul id="nameListUl"></ul>
      </div>
    </div>
  </div>

  <!-- Modal for check-in selection -->
  <div id="checkinModal" class="modal">
    <div class="modal-content">
      <p>Select a name to check in for this day:</p>
      <select id="checkinNameSelect"></select>
      <input id="checkinRemark" type="text" placeholder="Remark (optional)">
      <div class="modal-buttons">
        <button id="confirmCheckin">Check In</button>
        <button id="cancelCheckin">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Modal for cancel confirmation -->
  <div id="cancelModal" class="modal">
    <div class="modal-content">
      <p>Do you want to cancel this check-in?</p>
      <div class="modal-buttons">
        <button id="confirmCancel">Confirm Cancel</button>
        <button id="closeCancelModal">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Modal for toggling record status -->
  <div id="toggleStatusModal" class="modal">
    <div class="modal-content">
      <p>Change record to check-in status?</p>
      <div class="modal-buttons">
        <button id="confirmToggleStatus">Confirm</button>
        <button id="cancelToggleStatus">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // Utility function to generate a lighter version of an HSL color string
    function getLighterColor(hslString) {
      const regex = /hsl\((\d+),\s*(\d+)%\s*,\s*(\d+)%\)/;
      const result = regex.exec(hslString);
      if (result) {
        const hue = result[1];
        const saturation = result[2];
        let lightness = parseInt(result[3]);
        // Increase lightness by 20 (capped at 90)
        let newLightness = Math.min(lightness + 20, 90);
        return `hsl(${hue}, ${saturation}%, ${newLightness}%)`;
      }
      return hslString;
    }
    
    // Global array to store names
    let nameList = [];
    
    // CheckinRecord class definition to store name, color, check-in day, and optional remark
    class CheckinRecord {
      // Static properties for color mapping and hue generation
      static colorMapping = {};
      static currentHue = Math.random() * 360;
      static goldenRatioConjugate = 0.618033988749895;
      
      constructor(name, day, remark = "") {
        this.name = name;
        this.day = day;
        this.remark = remark;
        // Set status: if remark is provided, default to "remark" mode; otherwise, "checkin"
        this.status = (remark ? "remark" : "checkin");
        // Use existing color if available; otherwise, generate a new, darker base color (lightness 60%)
        if (CheckinRecord.colorMapping[name]) {
          this.color = CheckinRecord.colorMapping[name];
        } else {
          CheckinRecord.currentHue = (CheckinRecord.currentHue + 360 * CheckinRecord.goldenRatioConjugate) % 360;
          this.color = "hsl(" + Math.floor(CheckinRecord.currentHue) + ", 90%, 60%)";
          CheckinRecord.colorMapping[name] = this.color;
        }
      }
      
      // Render method returns a div element representing this check-in record.
      render() {
        const div = document.createElement("div");
        div.className = "checkin";
        if (this.status === "remark") {
          const lighter = getLighterColor(this.color);
          div.style.backgroundColor = lighter;
          div.style.color = ""; // default text color
          div.innerText = `${this.name} (${this.remark})`;
        } else {
          div.style.backgroundColor = this.color;
          div.style.color = "white";
          div.innerText = this.remark ? `${this.name} (${this.remark})` : this.name;
        }
        div.setAttribute("data-day", this.day);
        div.setAttribute("data-name", this.name);
        div.setAttribute("data-remark", this.remark);
        div.setAttribute("data-status", this.status);
        return div;
      }
    }
    
    // Establish a connection using Socket.IO
    const socket = io();
    socket.on("connect", () => {
      console.log("Socket.IO connection established");
    });
    socket.on("message", (data) => {
      console.log("Message received:", data);
    });
    
    // Generate a simple calendar for the current month
    const calendar = document.getElementById("calendar");
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    let html = "<tr>";
    // Add leading empty cells
    for (let i = 0; i < firstDay; i++) {
      html += "<td></td>";
    }
    for (let day = 1; day <= daysInMonth; day++) {
      if ((firstDay + day - 1) % 7 === 0 && day > 1) {
        html += "</tr><tr>";
      }
      html += `<td data-day="${day}">
                <div class="date">${day}</div>
                <div class="checkins"></div>
              </td>`;
    }
    html += "</tr>";
    calendar.innerHTML = html;
    
    // Global variable to store the record element being toggled
    let currentToggleRecordElement = null;
    let currentDay = null; // To store the selected day for check-in
    
    // Function to update the display of the name list in the modal
    function updateNameListDisplay() {
      const ul = document.getElementById("nameListUl");
      ul.innerHTML = "";
      nameList.forEach(name => {
        const li = document.createElement("li");
        li.innerText = name;
        li.style.backgroundColor = CheckinRecord.colorMapping[name] || "#ffffff";
        li.addEventListener("click", function() {
          if (confirm("Do you want to delete " + name + " from the list?")) {
            nameList = nameList.filter(n => n !== name);
            delete CheckinRecord.colorMapping[name];
            updateNameListDisplay();
          }
        });
        ul.appendChild(li);
      });
    }
    
    // Event listener for the Build Name List button
    document.getElementById("buildNameListButton").addEventListener("click", function() {
      document.getElementById("nameListModal").style.display = "block";
      updateNameListDisplay();
    });
    
    // Event listener for the Add Name button in the modal
    document.getElementById("addNameButton").addEventListener("click", function() {
      const newName = document.getElementById("newNameInput").value.trim();
      if (newName && !nameList.includes(newName)) {
        nameList.push(newName);
        if (!CheckinRecord.colorMapping[newName]) {
          CheckinRecord.currentHue = (CheckinRecord.currentHue + 360 * CheckinRecord.goldenRatioConjugate) % 360;
          CheckinRecord.colorMapping[newName] = "hsl(" + Math.floor(CheckinRecord.currentHue) + ", 70%, 50%)";
        }
        updateNameListDisplay();
      }
      document.getElementById("newNameInput").value = "";
    });
    
    // Event listener to close the name list modal
    document.getElementById("closeNameListModal").addEventListener("click", function() {
      document.getElementById("nameListModal").style.display = "none";
    });
    
    // When a calendar cell is clicked, open the check-in modal
    document.querySelectorAll("#calendar td").forEach(td => {
      td.addEventListener("click", function(e) {
        if (e.target.classList.contains("checkin")) return;
        currentDay = this.getAttribute("data-day");
        if (nameList.length === 0) {
          alert("Please build the name list first.");
          return;
        }
        populateCheckinDropdown();
        document.getElementById("checkinModal").style.display = "block";
      });
    });
    
    // Populate the check-in dropdown with names from the global nameList
    function populateCheckinDropdown() {
      const select = document.getElementById("checkinNameSelect");
      select.innerHTML = "";
      nameList.forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        option.text = name;
        select.appendChild(option);
      });
    }
    
    // Check-in modal confirm button event: create a new record
    document.getElementById("confirmCheckin").addEventListener("click", function() {
      const selectedName = document.getElementById("checkinNameSelect").value;
      const remark = document.getElementById("checkinRemark").value.trim();
      if (selectedName && currentDay) {
        let record = new CheckinRecord(selectedName, currentDay, remark);
        // Send a checkin event to the backend
        socket.emit("message", { action: "checkin", day: currentDay, name: selectedName, remark: remark });
        let td = document.querySelector(`#calendar td[data-day='${currentDay}']`);
        let checkinsDiv = td.querySelector(".checkins");
        let checkinDiv = record.render();
        checkinsDiv.appendChild(checkinDiv);
        
        // Attach event listener to the record element
        checkinDiv.addEventListener("click", function(e) {
          e.stopPropagation();
          if (this.getAttribute("data-status") === "remark") {
            currentToggleRecordElement = this;
            document.getElementById("toggleStatusModal").style.display = "block";
          } else {
            const day = this.getAttribute("data-day");
            const name = this.getAttribute("data-name");
            document.getElementById("cancelModal").style.display = "block";
            document.getElementById("confirmCancel").setAttribute("data-day", day);
            document.getElementById("confirmCancel").setAttribute("data-name", name);
          }
        });
      }
      document.getElementById("checkinModal").style.display = "none";
      document.getElementById("checkinRemark").value = "";
      currentDay = null;
    });
    
    // Check-in modal cancel button event
    document.getElementById("cancelCheckin").addEventListener("click", function() {
      document.getElementById("checkinModal").style.display = "none";
      document.getElementById("checkinRemark").value = "";
      currentDay = null;
    });
    
    // Cancel modal events: close and confirm cancel
    document.getElementById("closeCancelModal").addEventListener("click", function() {
      document.getElementById("cancelModal").style.display = "none";
    });
    document.getElementById("confirmCancel").addEventListener("click", function() {
      let day = this.getAttribute("data-day");
      let name = this.getAttribute("data-name");
      // Send a cancel event to the backend
      socket.emit("message", { action: "cancel", day: day, name: name });
      let td = document.querySelector(`#calendar td[data-day='${day}']`);
      let checkinDivs = td.querySelectorAll(".checkin");
      checkinDivs.forEach(div => {
        if (div.getAttribute("data-name") === name) {
          td.querySelector(".checkins").removeChild(div);
        }
      });
      document.getElementById("cancelModal").style.display = "none";
    });
    
    // Toggle Status modal events: confirm and cancel toggle
    document.getElementById("confirmToggleStatus").addEventListener("click", function() {
      if (currentToggleRecordElement) {
        const name = currentToggleRecordElement.getAttribute("data-name");
        const baseColor = CheckinRecord.colorMapping[name];
        currentToggleRecordElement.style.backgroundColor = baseColor;
        currentToggleRecordElement.style.color = "white";
        currentToggleRecordElement.setAttribute("data-status", "checkin");
      }
      document.getElementById("toggleStatusModal").style.display = "none";
      currentToggleRecordElement = null;
    });
    document.getElementById("cancelToggleStatus").addEventListener("click", function() {
      document.getElementById("toggleStatusModal").style.display = "none";
      currentToggleRecordElement = null;
    });
  </script>
</body>
</html>

