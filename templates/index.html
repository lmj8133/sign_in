<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attendance Sheet - Calendar</title>
  <!-- Use Google Fonts (Roboto) for a modern look -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f1f3f4;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #202124;
      margin-bottom: 20px;
    }
    /* Build Name List button style (fixed top-right) */
    #buildNameListButton {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #1a73e8;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 10px 16px;
      cursor: pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,0.2);
      z-index: 1001;
    }
    #buildNameListButton:hover {
      background-color: #1558b0;
    }
    /* Calendar table styling */
    table {
      width: 100%;
      max-width: 900px;
      margin: 80px auto;
      background: white;
      border-collapse: collapse;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      border-radius: 4px;
      overflow: hidden;
    }
    th {
      background-color: #1a73e8;
      color: white;
      padding: 10px;
      font-size: 14px;
    }
    td {
      width: 14.28%;
      height: 100px;
      vertical-align: top;
      position: relative;
      padding: 5px;
      border: 1px solid #e0e0e0;
    }
    /* Cells not in the current month are grayed out */
    td.prev-month, td.next-month {
      background-color: #e0e0e0;
      color: #999;
      pointer-events: none;
    }
    .date {
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 12px;
      color: inherit;
    }
    .checkins {
      margin-top: 25px;
      overflow-y: auto;
      max-height: 70px;
    }
    .checkin {
      margin: 2px 0;
      padding: 2px 4px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* Modal styling */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(60,64,67,0.3);
    }
    .modal-content {
      background: white;
      width: 320px;
      margin: 15% auto;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .modal-buttons button {
      padding: 8px 12px;
      margin: 10px 5px 0 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .modal-buttons button:hover {
      opacity: 0.9;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      font-size: 14px;
    }
    ul {
      list-style: none;
      padding: 0;
      margin-top: 10px;
      text-align: left;
    }
    ul li {
      padding: 8px;
      margin: 4px 0;
      background: #f8f9fa;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    ul li:hover {
      background: #e8eaed;
    }
  </style>
  <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
</head>
<body>
  <h1 id="calendarTitle">Attendance Sheet - Calendar</h1>
  <button id="buildNameListButton">Build Name List</button>
  
  <table id="calendar">
    <!-- Calendar will be generated dynamically -->
  </table>
  
  <!-- Modal for building the name list -->
  <div id="nameListModal" class="modal">
    <div class="modal-content">
      <p>Enter a name to add to the list:</p>
      <input id="newNameInput" type="text" placeholder="Name">
      <div class="modal-buttons">
        <button id="addNameButton" style="background:#34a853; color:white;">Add Name</button>
        <button id="closeNameListModal" style="background:#ea4335; color:white;">Close</button>
      </div>
      <div id="nameListDisplay" style="margin-top:10px;">
        <p>Current Names (click to delete):</p>
        <ul id="nameListUl"></ul>
      </div>
    </div>
  </div>

  <!-- Modal for check-in selection -->
  <div id="checkinModal" class="modal">
    <div class="modal-content">
      <p>Select a name to check in for this day:</p>
      <select id="checkinNameSelect"></select>
      <input id="checkinRemark" type="text" placeholder="Remark (optional)">
      <!-- Add hours input field, default is 1 -->
      <input id="checkinHours" type="number" placeholder="Hours" value="1" min="1" step="0.5">
      <div class="modal-buttons">
        <button id="confirmCheckin" style="background:#34a853; color:white;">Check In</button>
        <button id="remarkButton" style="background:#1a73e8; color:white;">Remark</button>
        <button id="cancelCheckin" style="background:#ea4335; color:white;">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- Modal for editing a check-in record (update remark, toggle status, cancel record) -->
  <div id="editRecordModal" class="modal">
    <div class="modal-content">
      <p>Edit Check-in Record</p>
      <input id="editRemarkInput" type="text" placeholder="Remark (optional)">
      <div class="modal-buttons">
        <button id="updateRemarkButton" style="background:#34a853; color:white;">Update Remark</button>
        <button id="toggleStatusButton" style="background:#1a73e8; color:white;">Toggle Status</button>
        <button id="cancelRecordButton" style="background:#ea4335; color:white;">Cancel Record</button>
        <button id="closeEditRecordModal" style="background:#5f6368; color:white;">Close</button>
      </div>
    </div>
  </div>
  
  <script>
    // djb2 algorithm: compute color from a given name
    function getColorFromName(name) {
      let hash = 5381;
      for (let i = 0; i < name.length; i++) {
        hash = ((hash << 5) + hash) + name.charCodeAt(i);
      }
      let hue = Math.abs(hash) % 360;
      return `hsl(${hue}, 90%, 60%)`;
    }
    
    // Get a lighter version of an HSL color string
    function getLighterColor(hslString) {
      const regex = /hsl\((\d+),\s*(\d+)%\s*,\s*(\d+)%\)/;
      const result = regex.exec(hslString);
      if (result) {
        const hue = result[1];
        const saturation = result[2];
        let lightness = parseInt(result[3]);
        let newLightness = Math.min(lightness + 20, 90);
        return `hsl(${hue}, ${saturation}%, ${newLightness}%)`;
      }
      return hslString;
    }
    
    let nameList = [];
    let checkinData = {};
    let currentToggleRecordElement = null;
    
    // CheckinRecord class: stores name, day, remark, status ("checkin" or "remark"), and check-in hours
    class CheckinRecord {
      static colorMapping = {};
      constructor(name, day, remark = "", status = null, hours = null) {
        this.name = name;
        this.day = day;
        this.remark = remark;
        // Default status is "checkin" unless a remark exists or a status is provided
        this.status = status ? status : (remark ? "remark" : "checkin");
        // Convert hours to a float if provided
        this.hours = hours !== null ? parseFloat(hours) : null;
        if (CheckinRecord.colorMapping[name]) {
          this.color = CheckinRecord.colorMapping[name];
        } else {
          let color = getColorFromName(name);
          CheckinRecord.colorMapping[name] = color;
          this.color = color;
        }
      }
      render() {
        const div = document.createElement("div");
        div.className = "checkin";
        if (this.status === "checkin") {
          div.style.backgroundColor = this.color;
          div.style.color = "black";
          let text = this.name;
          if (this.remark) {
            text += ` (${this.remark})`;
          }
          if (this.hours !== null) {
            text += ` [${this.hours} hrs]`;
          }
          div.innerHTML = text;
        } else {
          // For remark records, no icon is displayed.
          const lighter = getLighterColor(this.color);
          div.style.backgroundColor = lighter;
          div.style.color = "";
          div.innerText = this.remark ? `${this.name} (${this.remark})` : this.name;
        }
        div.setAttribute("data-day", this.day);
        div.setAttribute("data-name", this.name);
        div.setAttribute("data-remark", this.remark);
        div.setAttribute("data-status", this.status);
        return div;
      }
    }
    
    // Connect to backend using socket.io
    const socket = io();
    socket.on("connect", () => {
      console.log("Socket.IO connection established");
    });
    socket.on("message", (data) => {
      console.log("Message received:", data);
    });
    socket.on("initial_data", (data) => {
      nameList = data.names || [];
      checkinData = data.checkins || {};
      updateNameListDisplay();
      loadCheckinsForMonth(currentYear, currentMonth);
    });
    socket.on("month_data", (data) => {
      for (let key in data) {
        checkinData[key] = data[key];
      }
      loadCheckinsForMonth(currentYear, currentMonth);
    });
    
    function sendNameListUpdate() {
      socket.emit("message", { action: "update_names", names: nameList });
    }
    
    // Global variables for current year, month, and day
    let currentYear = (new Date()).getFullYear();
    let currentMonth = (new Date()).getMonth(); // 0-indexed
    let currentDay = null;
    
    // Format a date key as "YYYY-MM-DD"
    function formatDateKey(year, month, day) {
      return `${year}-${String(month+1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    }
    
    // Generate a fixed 6x7 calendar
    function generateCalendar(year, month) {
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      // Previous month info
      let prevMonth = month - 1, prevYear = year;
      if (prevMonth < 0) { prevMonth = 11; prevYear--; }
      const daysInPrevMonth = new Date(prevYear, prevMonth + 1, 0).getDate();
      
      // Next month info
      let nextMonth = month + 1, nextYear = year;
      if (nextMonth > 11) { nextMonth = 0; nextYear++; }
      
      let totalCells = 42; // Always 6 rows
      let calendarHTML = "<tr><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr>";
      
      for (let cell = 0; cell < totalCells; cell++) {
        if (cell % 7 === 0) { calendarHTML += "<tr>"; }
        let cellContent = "";
        let cellClass = "";
        let dataDay = "";
        let dateKey = "";
        if (cell < firstDay) {
          let dateNum = daysInPrevMonth - (firstDay - cell - 1);
          cellContent = dateNum;
          cellClass = "prev-month";
          dateKey = formatDateKey(prevYear, prevMonth, dateNum);
        } else if (cell < firstDay + daysInMonth) {
          let dateNum = cell - firstDay + 1;
          cellContent = dateNum;
          cellClass = "current-month";
          dataDay = dateNum;
          dateKey = formatDateKey(year, month, dateNum);
        } else {
          let dateNum = cell - (firstDay + daysInMonth) + 1;
          cellContent = dateNum;
          cellClass = "next-month";
          dateKey = formatDateKey(nextYear, nextMonth, dateNum);
        }
        calendarHTML += `<td class="${cellClass}" data-date="${dateKey}" data-day="${dataDay}">
                           <div class="date">${cellContent}</div>
                           <div class="checkins"></div>
                         </td>`;
        if (cell % 7 === 6) { calendarHTML += "</tr>"; }
      }
      
      document.getElementById("calendar").innerHTML = calendarHTML;
      updateCalendarCellEvents();
      updateCalendarTitle(year, month);
      // Request month data for current, previous, and next months
      socket.emit("get_month_data", { year: currentYear, month: currentMonth });
      socket.emit("get_month_data", { year: prevYear, month: prevMonth });
      socket.emit("get_month_data", { year: nextYear, month: nextMonth });
    }
    
    function updateCalendarTitle(year, month) {
      const monthNames = ["January", "February", "March", "April", "May", "June",
                          "July", "August", "September", "October", "November", "December"];
      document.getElementById("calendarTitle").innerText = `Attendance Sheet - ${monthNames[month]} ${year}`;
    }
    
    // Attach click events to current month cells to open the check-in modal
    function updateCalendarCellEvents() {
      document.querySelectorAll("#calendar td.current-month").forEach(td => {
        td.addEventListener("click", function(e) {
          currentDay = this.getAttribute("data-day");
          if (nameList.length === 0) {
            alert("Please build the name list first.");
            return;
          }
          populateCheckinDropdown();
          document.getElementById("checkinModal").style.display = "block";
        });
      });
    }
    
    // Load check-in records for each date cell using the data-date attribute
    function loadCheckinsForMonth(year, month) {
      document.querySelectorAll("#calendar td[data-date]").forEach(td => {
        let dateKey = td.getAttribute("data-date");
        let checkinsDiv = td.querySelector(".checkins");
        checkinsDiv.innerHTML = "";
        if (checkinData[dateKey]) {
          checkinData[dateKey].forEach(record => {
            let personName = typeof record === "object" ? record.name : record;
            let remark = typeof record === "object" ? record.remark : "";
            let status = (typeof record === "object" && record.status) ? record.status 
                         : (remark ? "remark" : "checkin");
            let hours = (typeof record === "object" && record.hours) ? record.hours : null;
            let displayedDay = td.querySelector(".date").innerText;
            let checkinRecord = new CheckinRecord(personName, displayedDay, remark, status, hours);
            let checkinDiv = checkinRecord.render();
            // When a record is clicked, open the edit record modal
            checkinDiv.addEventListener("click", function(e) {
              e.stopPropagation();
              currentToggleRecordElement = this;
              document.getElementById("editRemarkInput").value = this.getAttribute("data-remark");
              document.getElementById("editRecordModal").style.display = "block";
            });
            checkinsDiv.appendChild(checkinDiv);
          });
        }
      });
    }
    
    // Initialize calendar for the current month on page load
    generateCalendar(currentYear, currentMonth);
    
    // Mouse wheel navigation to switch months
    window.addEventListener("wheel", function(e) {
      if (e.deltaY < 0) { // Previous month
        currentMonth--;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        }
        generateCalendar(currentYear, currentMonth);
      } else if (e.deltaY > 0) { // Next month
        currentMonth++;
        if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        generateCalendar(currentYear, currentMonth);
      }
    });
    
    // Update the name list display
    function updateNameListDisplay() {
      const ul = document.getElementById("nameListUl");
      ul.innerHTML = "";
      nameList.forEach(name => {
        const li = document.createElement("li");
        li.innerText = name;
        li.style.backgroundColor = CheckinRecord.colorMapping[name] || "#ffffff";
        li.addEventListener("click", function() {
          if (confirm("Do you want to delete " + name + " from the list?")) {
            nameList = nameList.filter(n => n !== name);
            delete CheckinRecord.colorMapping[name];
            updateNameListDisplay();
            sendNameListUpdate();
          }
        });
        ul.appendChild(li);
      });
    }
    
    document.getElementById("buildNameListButton").addEventListener("click", function() {
      document.getElementById("nameListModal").style.display = "block";
      updateNameListDisplay();
    });
    
    document.getElementById("addNameButton").addEventListener("click", function() {
      const newName = document.getElementById("newNameInput").value.trim();
      if (newName && !nameList.includes(newName)) {
        nameList.push(newName);
        if (!CheckinRecord.colorMapping[newName]) {
          CheckinRecord.colorMapping[newName] = getColorFromName(newName);
        }
        updateNameListDisplay();
        sendNameListUpdate();
      }
      document.getElementById("newNameInput").value = "";
    });
    
    document.getElementById("closeNameListModal").addEventListener("click", function() {
      document.getElementById("nameListModal").style.display = "none";
    });
    
    function populateCheckinDropdown() {
      const select = document.getElementById("checkinNameSelect");
      select.innerHTML = "";
      nameList.forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        option.text = name;
        select.appendChild(option);
      });
    }
    
    // Confirm check-in: create a record with status "checkin" and send hours data to backend
    document.getElementById("confirmCheckin").addEventListener("click", function() {
      const selectedName = document.getElementById("checkinNameSelect").value;
      const remark = document.getElementById("checkinRemark").value.trim();
      // Get the input hours value as a float, default to 1 if empty
      const hours = parseFloat(document.getElementById("checkinHours").value) || 1;
      if (selectedName && currentDay) {
        let td = document.querySelector(`#calendar td.current-month[data-day='${currentDay}']`);
        let checkinsDiv = td.querySelector(".checkins");
        const alreadyCheckedIn = Array.from(checkinsDiv.getElementsByClassName("checkin"))
          .some(div => div.getAttribute("data-name") === selectedName);
        if (alreadyCheckedIn) {
          alert("This person has already checked in for today.");
          document.getElementById("checkinModal").style.display = "none";
          document.getElementById("checkinRemark").value = "";
          currentDay = null;
          return;
        }
        // Pass the hours value into the new CheckinRecord
        let record = new CheckinRecord(selectedName, currentDay, remark, "checkin", hours);
        // Send hours data along with check-in action to the backend
        socket.emit("message", { 
          action: "checkin", 
          year: currentYear, 
          month: currentMonth, 
          day: currentDay, 
          name: selectedName, 
          remark: remark,
          hours: hours
        });
        let checkinDiv = record.render();
        checkinsDiv.appendChild(checkinDiv);
        checkinDiv.addEventListener("click", function(e) {
          e.stopPropagation();
          currentToggleRecordElement = this;
          document.getElementById("editRemarkInput").value = this.getAttribute("data-remark");
          document.getElementById("editRecordModal").style.display = "block";
        });
      }
      document.getElementById("checkinModal").style.display = "none";
      document.getElementById("checkinRemark").value = "";
      // Reset hours input to default value
      document.getElementById("checkinHours").value = 1;
      currentDay = null;
    });
    
    // Remark button event: create a record with status "remark" without hours data
    document.getElementById("remarkButton").addEventListener("click", function() {
      const selectedName = document.getElementById("checkinNameSelect").value;
      const remark = document.getElementById("checkinRemark").value.trim();
      if (selectedName && currentDay) {
        let td = document.querySelector(`#calendar td.current-month[data-day='${currentDay}']`);
        let checkinsDiv = td.querySelector(".checkins");
        const alreadyCheckedIn = Array.from(checkinsDiv.getElementsByClassName("checkin"))
          .some(div => div.getAttribute("data-name") === selectedName);
        if (alreadyCheckedIn) {
          alert("This person has already checked in for today.");
          document.getElementById("checkinModal").style.display = "none";
          document.getElementById("checkinRemark").value = "";
          currentDay = null;
          return;
        }
        let record = new CheckinRecord(selectedName, currentDay, remark, "remark");
        socket.emit("message", { 
          action: "remark", 
          year: currentYear, 
          month: currentMonth, 
          day: currentDay, 
          name: selectedName, 
          remark: remark
        });
        let checkinDiv = record.render();
        checkinsDiv.appendChild(checkinDiv);
        checkinDiv.addEventListener("click", function(e) {
          e.stopPropagation();
          currentToggleRecordElement = this;
          document.getElementById("editRemarkInput").value = this.getAttribute("data-remark");
          document.getElementById("editRecordModal").style.display = "block";
        });
      }
      document.getElementById("checkinModal").style.display = "none";
      document.getElementById("checkinRemark").value = "";
      currentDay = null;
    });

    document.getElementById("cancelCheckin").addEventListener("click", function() {
      document.getElementById("checkinModal").style.display = "none";
      document.getElementById("checkinRemark").value = "";
      currentDay = null;
    });
    
    // Edit modal button events:
    
    // Update remark: update only the remark without changing status
    document.getElementById("updateRemarkButton").addEventListener("click", function() {
      if (currentToggleRecordElement) {
        const newRemark = document.getElementById("editRemarkInput").value.trim();
        const name = currentToggleRecordElement.getAttribute("data-name");
        const day = currentToggleRecordElement.getAttribute("data-day");
        currentToggleRecordElement.setAttribute("data-remark", newRemark);
        // Update displayed text; for check-in records include icon image
        if (currentToggleRecordElement.getAttribute("data-status") === "checkin") {
          const iconUrl = "https://img.icons8.com/color/16/000000/checked-checkbox.png";
          currentToggleRecordElement.innerHTML = `<img src="${iconUrl}" style="vertical-align:middle; margin-right:4px;">` +
            (newRemark ? `${name} (${newRemark})` : name);
        } else {
          currentToggleRecordElement.innerText = newRemark ? `${name} (${newRemark})` : name;
        }
        socket.emit("message", { 
          action: "update_remark", 
          year: currentYear, 
          month: currentMonth, 
          day: day, 
          name: name, 
          remark: newRemark 
        });
      }
      document.getElementById("editRecordModal").style.display = "none";
      currentToggleRecordElement = null;
    });
    
    // Toggle status: switch between "checkin" and "remark" and inform backend
    document.getElementById("toggleStatusButton").addEventListener("click", function() {
      if (currentToggleRecordElement) {
        const name = currentToggleRecordElement.getAttribute("data-name");
        const day = currentToggleRecordElement.getAttribute("data-day");
        let currentStatus = currentToggleRecordElement.getAttribute("data-status");
        currentStatus = currentStatus === "checkin" ? "remark" : "checkin";
        currentToggleRecordElement.setAttribute("data-status", currentStatus);
        if (currentStatus === "checkin") {
          const iconUrl = "https://img.icons8.com/color/16/000000/checked-checkbox.png";
          currentToggleRecordElement.style.backgroundColor = CheckinRecord.colorMapping[name];
          currentToggleRecordElement.style.color = "black";
          currentToggleRecordElement.innerHTML = `<img src="${iconUrl}" style="vertical-align:middle; margin-right:4px;">` + 
            currentToggleRecordElement.getAttribute("data-name") + (currentToggleRecordElement.getAttribute("data-remark") ? 
            ` (${currentToggleRecordElement.getAttribute("data-remark")})` : "");
        } else {
          const lighter = getLighterColor(CheckinRecord.colorMapping[name]);
          currentToggleRecordElement.style.backgroundColor = lighter;
          currentToggleRecordElement.style.color = "";
          currentToggleRecordElement.innerText = currentToggleRecordElement.getAttribute("data-name") + 
            (currentToggleRecordElement.getAttribute("data-remark") ? ` (${currentToggleRecordElement.getAttribute("data-remark")})` : "");
        }
        // Inform backend with toggled status
        socket.emit("message", { 
          action: "toggle_status", 
          year: currentYear, 
          month: currentMonth, 
          day: day, 
          name: name, 
          status: currentStatus,
          toggled: true
        });
      }
      document.getElementById("editRecordModal").style.display = "none";
      currentToggleRecordElement = null;
    });
    
    // Cancel record: remove the record and inform backend
    document.getElementById("cancelRecordButton").addEventListener("click", function() {
      if (currentToggleRecordElement) {
        const day = currentToggleRecordElement.getAttribute("data-day");
        const name = currentToggleRecordElement.getAttribute("data-name");
        socket.emit("message", { 
          action: "cancel", 
          year: currentYear, 
          month: currentMonth, 
          day: day, 
          name: name 
        });
        const td = document.querySelector(`#calendar td.current-month[data-day='${day}']`);
        td.querySelector(".checkins").removeChild(currentToggleRecordElement);
      }
      document.getElementById("editRecordModal").style.display = "none";
      currentToggleRecordElement = null;
    });
    
    document.getElementById("closeEditRecordModal").addEventListener("click", function() {
      document.getElementById("editRecordModal").style.display = "none";
      currentToggleRecordElement = null;
    });
    
  </script>
</body>
</html>

